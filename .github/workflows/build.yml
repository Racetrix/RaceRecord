name: Build and Release Windows Exe

on:
  push:
    branches: [ "main" ] # 新增：代码推送到 main 分支时也会触发编译
    tags: [ "v*" ]       # 保持：打 v 开头的 tag 时触发
  workflow_dispatch:     # 保持：允许手动点击按钮触发

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller
        if (Test-Path requirements.txt) { pip install -r requirements.txt }

    # --- 编译步骤 (每次 Push 都会跑) ---
    
    - name: Build Release Version (No Console)
      run: |
        pyinstaller --onefile --clean --noconsole --copy-metadata imageio --name "Racetrix" race_app.py

    - name: Build Debug Version (With Console)
      run: |
        pyinstaller --onefile --clean --console --copy-metadata imageio --name "Racetrix_Debug" race_app.py

    # --- 上传到 Action Artifacts (每次 Push 都会跑) ---
    # 这样你平时 Push 代码后，可以在 Actions 页面底部下载来测试，但不会发版
    
    - name: Upload Release Artifact
      uses: actions/upload-artifact@v4
      with:
        name: Racetrix-Release-Version
        path: dist/Racetrix.exe

    - name: Upload Debug Artifact
      uses: actions/upload-artifact@v4
      with:
        name: Racetrix-Debug-Version
        path: dist/Racetrix_Debug.exe

    # --- 发布到 Release 页面 (仅当打 Tag 时才跑) ---
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')  # 关键判断：只有 Tag 触发时才执行这一步
      with:
        files: |
          dist/Racetrix.exe
          dist/Racetrix_Debug.exe